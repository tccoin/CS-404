# 流畅Py - 函数

> 读到这里不知道为什么有点烦躁了…感觉这本书讲的也太散了一点，这一章反复过了两三遍还是没理解行文思路。所以笔记干脆就挑重点的自己写了。

## 函数是对象

Python里，什么都是对象，懂了8。~~不懂就对了！~~甚至任何对象只要实现了`__call__`方法就可以表现得像一个函数。

~~至于“与我何与也”这种问题，自己品味吧。~~

## 函数内省

函数内省可以让我们康康函数和普通对象在实现上有什么区别。

> 内省是指计算机程序在运行时（Run time）检查对象（Object）类型的一种能力。
> by  [Wikipedia](https://zh.wikipedia.org/zh-hans/%E5%86%85%E7%9C%81_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)

```python
>>> class C:
...   pass
...
>>> obj = C()
>>> def func():
...   pass
...
>>> sorted(set(dir(func)) - set(dir(obj)))
['__annotations__', '__call__', '__closure__', '__code__', '__defaults__', '__get__', '__globals__', '__kwdefaults__', '__name__', '__qualname__']
```

## 参数

- 必选参数`def(x)`
- 默认参数`def(x=1)`
- 可变参数`def(*x)`，x是传入的参数打包成的truple
- 关键字参数`def(**x)`，x是把传入的含参数名的参数打包成的dict

在传递及设置参数时必须按上面这个顺序来写。

## 默认参数的坑

讲默认参数的坑之前先说一下Python是怎么设置变量的。

```
i = 0;
i = i+1;
```

考虑上面的伪代码，C语言之类的~~lowb~~语言的执行的效果是给i这个变量分块内存，把0存在里面，第二行把i+1的值再存在这块内存里面，所以i指向的内存没有变化过；而可亲可爱的Python却不这样做，首先它分一块内存，把0存在里面，然后把i指向这块内存，第二行里Python再开一块内存，把i+1存在里面，再让i指向这块内存，相当于每次赋值其实是把i指向新的地址，然后Python要是寻思着这前一块内存没人要了呢，就把前一块内存给释放了。

另外，Python里有可变参数和不可变参数之分，对于不可变参数如`int, string, float, number, tuple`，这些类型的对象本身的值是不可改变的，它们所有的方法都无法改变本身的值，如果想要修改的话只能返回一个新的对象；而对于其它的可变参数如`dict, lsit`，正相反，它们本身的值是可以被修改的。参考一下的代码，对于number，修改值之后id变了；对于list，增加一个元素并没有改变它的id。

```python
n=0
print(id(n)) #1955922352
n=n+1
print(id(n)) #1955922384

d = ['1']
print(id(d)) #3185073072200
d += ['2']
print(id(d)) #3185073072200
```

好，那么问题来了。函数是对象意味着什么？意味着所有默认参数在声明函数的时候就已经分配好了内存/地址，每次调用函数时如果没有传入相应的参数而要调用默认值时，Python就把这个参数指向早就分配好的地址。问题就在这。考虑，如果默认参数是个可变参数，那么一旦这个可变参数被修改了，那么下一次调用这个函数的默认值时，你会发现这个默认值竟然是之前修改过的参数！看看这段代码：

```python
def func(dict=[]):
    dict += ['boom']
    print(dict)


func() #['boom']
func() #['boom', 'boom']
```

> 明明都是一模一样的调用方式，怎么调用“默认值”却返回了不一样的结果呢…为什么，会变成这样呢……

懂了吧，第一次调用的时候偷偷修改了函数默认值（可变对象）的话第二次调用就会有副作用。而设置不可变对象为默认值就不会这样，原因…自己想。

所以建议是不要在默认参数里用可变对象！

## 函数式编程

> 函数式编程是种编程方式，它将电脑运算视为函数的计算。函数编程语言最重要的基础是λ演算（lambda calculus），而且λ演算的函数可以接受函数当作输入（参数）和输出（返回值）。
> from [百度百科](https://baike.baidu.com/item/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B) ~~我就是喜欢这两个学术禁忌网站怎么样呀~~

我的理解的话函数式编程就是用函数来构造函数。这里要注意，不是说Python是一门函数式编程语言，相反，应该是Python从函数式编程借鉴了一些东西。

- 用lambda临时构造包括基本操作的函数
  - Python中的lambda有很多限制比如只能有一个表达式，返回值即表达式的值，这样设计正是为了避免开发者用lambda写过于复杂的逻辑，不便于debug及后续维护
- 用functools.partial冻结某个函数的一些参数来构成新的函数。这个函数返回一个函数。用例如下：

```python
from functools import partial

def mul(a, b):
    return a*b
triple = partial(mul, 3)

print([triple(n) for n in range(10)])
#[0, 3, 6, 9, 12, 15, 18, 21, 24, 27]
```